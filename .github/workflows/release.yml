name: Release Pipeline

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Create Release Build
  release-build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Update versions
        run: |
          # Update parent version
          mvn versions:set -DnewVersion=${{ steps.version.outputs.version }}
          
          # Update all modules
          find . -name "pom.xml" -not -path "./target/*" | xargs sed -i 's/<financer-parent.version>.*<\/financer-parent.version>/<financer-parent.version>${{ steps.version.outputs.version }}<\/financer-parent.version>/g'

      - name: Build all services
        run: |
          mvn clean package -DskipTests
          
          # Build shared libraries
          cd shared/common-lib && mvn clean install -DskipTests
          cd ../eureka-integration && mvn clean install -DskipTests
          cd ../..
          
          # Build all microservices
          services=("config-server" "eureka-server" "api-gateway" "account-service")
          for service in "${services[@]}"; do
            echo "Building $service..."
            cd microservices/$service
            mvn clean package -DskipTests
            cd ../..
          done

      - name: Create release artifacts
        run: |
          mkdir -p release-artifacts
          
          # Copy JARs
          find microservices -name "*.jar" -not -name "*original*" -exec cp {} release-artifacts/ \;
          
          # Copy Docker compose files
          cp docker-compose*.yml release-artifacts/
          cp -r scripts release-artifacts/
          
          # Create version info
          echo "Version: ${{ steps.version.outputs.version }}" > release-artifacts/VERSION.txt
          echo "Build Date: $(date)" >> release-artifacts/VERSION.txt
          echo "Commit: ${{ github.sha }}" >> release-artifacts/VERSION.txt

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ steps.version.outputs.version }}
          path: release-artifacts/

  # Job 2: Build and Push Docker Images for Release
  release-docker:
    runs-on: ubuntu-latest
    needs: release-build
    strategy:
      matrix:
        service: [config-server, eureka-server, api-gateway, account-service]
        include:
          - service: config-server
            version: "1.0.0"
            path: microservices/config-server
          - service: eureka-server
            version: "1.0.1"
            path: microservices/eureka-server
          - service: api-gateway
            version: "1.0.0"
            path: microservices/api-gateway
          - service: account-service
            version: "1.0.2"
            path: microservices/account-service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.release-build.outputs.version }}
          path: release-artifacts/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.path }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}-${{ matrix.service }}:${{ needs.release-build.outputs.version }}
            ${{ env.REGISTRY }}/${{ github.repository }}-${{ matrix.service }}:latest
          labels: |
            org.opencontainers.image.title=Financer ${{ matrix.service }}
            org.opencontainers.image.description=Financer microservice - ${{ matrix.service }}
            org.opencontainers.image.version=${{ needs.release-build.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          build-args: |
            VERSION=${{ needs.release-build.outputs.version }}

  # Job 3: Create GitHub Release
  create-release:
    runs-on: ubuntu-latest
    needs: [release-build, release-docker]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.release-build.outputs.version }}
          path: release-artifacts/

      - name: Generate changelog
        id: changelog
        run: |
          # Generate changelog from git log
          CHANGELOG=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Financer v${{ needs.release-build.outputs.version }}
          body: |
            ## üöÄ Financer Release v${{ needs.release-build.outputs.version }}
            
            ### What's Changed
            ${{ steps.changelog.outputs.changelog }}
            
            ### üì¶ Docker Images
            All services are available as Docker images:
            
            ```bash
            # Pull all images
            docker pull ghcr.io/${{ github.repository }}-config-server:${{ needs.release-build.outputs.version }}
            docker pull ghcr.io/${{ github.repository }}-eureka-server:${{ needs.release-build.outputs.version }}
            docker pull ghcr.io/${{ github.repository }}-api-gateway:${{ needs.release-build.outputs.version }}
            docker pull ghcr.io/${{ github.repository }}-account-service:${{ needs.release-build.outputs.version }}
            ```
            
            ### üõ†Ô∏è Installation
            
            1. Download the release artifacts
            2. Run: `scripts/start-all.bat` (Windows) or `scripts/start-all.sh` (Linux/Mac)
            3. Access:
               - Eureka Dashboard: http://localhost:8761
               - API Gateway: http://localhost:8090
               - Config Server: http://localhost:8888
               - Kafka UI: http://localhost:8080
            
            ### üìã System Requirements
            - Java 21+
            - Docker & Docker Compose
            - Maven 3.9+
            
            ### üîó Services
            - **Config Server**: Configuration management
            - **Eureka Server**: Service discovery
            - **API Gateway**: Request routing and load balancing
            - **Account Service**: Account management microservice
          draft: false
          prerelease: false

  # Job 4: Deploy to Production
  deploy-production:
    runs-on: ubuntu-latest
    needs: [release-build, release-docker]
    environment: production
    
    steps:
      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying Financer v${{ needs.release-build.outputs.version }} to Production"
          
          # Here you would add your actual deployment scripts
          # Examples:
          # - Update Kubernetes manifests
          # - Deploy to cloud provider
          # - Update load balancer configurations
          # - Run database migrations
          
          echo "‚úÖ Production deployment completed!"

  # Job 5: Post-Release Actions
  post-release:
    runs-on: ubuntu-latest
    needs: [create-release, deploy-production]
    
    steps:
      - name: Notify Teams
        run: |
          echo "üì¢ Notifying teams about release v${{ needs.release-build.outputs.version }}"
          # Add notification logic (Slack, Teams, email, etc.)
          
      - name: Update Documentation
        run: |
          echo "üìù Updating documentation for v${{ needs.release-build.outputs.version }}"
          # Add documentation update logic
          
      - name: Cleanup
        run: |
          echo "üßπ Cleaning up temporary resources"
          # Add cleanup logic if needed