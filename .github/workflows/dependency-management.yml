name: Dependency Management

on:
  schedule:
    # Run weekly on Mondays at 9 AM
    - cron: '0 9 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - '**/pom.xml'
      - '.github/workflows/dependency-management.yml'

jobs:
  # Job 1: Check for Outdated Dependencies
  check-dependencies:
    runs-on: ubuntu-latest
    outputs:
      updates-available: ${{ steps.check.outputs.updates-available }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Check for dependency updates
        id: check
        run: |
          echo "ğŸ” Checking for dependency updates..."
          
          # Generate dependency updates report
          mvn versions:display-dependency-updates > dependency-updates.txt
          mvn versions:display-plugin-updates >> dependency-updates.txt
          
          # Check if updates are available
          if grep -q "newer version available" dependency-updates.txt; then
            echo "updates-available=true" >> $GITHUB_OUTPUT
            echo "âœ… Dependency updates found"
          else
            echo "updates-available=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ All dependencies are up to date"
          fi
          
          cat dependency-updates.txt

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-updates-report
          path: dependency-updates.txt

  # Job 2: Security Vulnerability Check
  security-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run OWASP Dependency Check
        run: |
          echo "ğŸ”’ Running OWASP dependency security check..."
          mvn org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: target/dependency-check-report.html

  # Job 3: License Compliance Check
  license-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Generate license report
        run: |
          echo "ğŸ“„ Generating license compliance report..."
          mvn license:aggregate-third-party-report

      - name: Check for prohibited licenses
        run: |
          echo "âš–ï¸ Checking for prohibited licenses..."
          
          # List of prohibited licenses (customize as needed)
          prohibited_licenses=("GPL" "AGPL" "LGPL")
          
          if [ -f target/site/aggregate-third-party-report.html ]; then
            for license in "${prohibited_licenses[@]}"; do
              if grep -qi "$license" target/site/aggregate-third-party-report.html; then
                echo "âŒ Prohibited license found: $license"
                exit 1
              fi
            done
            echo "âœ… No prohibited licenses found"
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: target/site/aggregate-third-party-report.html

  # Job 4: Create Automated Update PR
  create-update-pr:
    runs-on: ubuntu-latest
    needs: [check-dependencies, security-check, license-check]
    if: needs.check-dependencies.outputs.updates-available == 'true' && github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Update dependencies
        run: |
          echo "ğŸ”„ Updating dependencies..."
          
          # Update patch versions only (safer)
          mvn versions:update-properties -DallowSnapshots=false -DallowMajorUpdates=false -DallowMinorUpdates=false
          
          # Update plugin versions
          mvn versions:update-plugins -DallowSnapshots=false -DallowMajorUpdates=false -DallowMinorUpdates=false

      - name: Build and test after updates
        run: |
          echo "ğŸ§ª Testing after dependency updates..."
          mvn clean compile test

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies (automated)"
          title: "ğŸ”„ Automated Dependency Updates"
          body: |
            ## ğŸ”„ Automated Dependency Updates
            
            This PR contains automated dependency updates generated by the dependency management workflow.
            
            ### Changes Made
            - â¬†ï¸ Updated patch versions of dependencies
            - ğŸ”§ Updated Maven plugin versions
            - âœ… All tests pass after updates
            
            ### Security Status
            - ğŸ”’ No security vulnerabilities detected
            - âš–ï¸ License compliance verified
            
            ### Next Steps
            1. Review the changes
            2. Run additional tests if needed
            3. Merge if everything looks good
            
            **Generated automatically by GitHub Actions**
          branch: dependency-updates
          delete-branch: true

  # Job 5: Dependency Dashboard
  create-dashboard:
    runs-on: ubuntu-latest
    needs: [check-dependencies, security-check, license-check]
    if: always()
    
    steps:
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          name: dependency-updates-report
          path: reports/

      - name: Create dependency dashboard
        run: |
          echo "ğŸ“Š Creating dependency dashboard..."
          
          cat << EOF > dependency-dashboard.md
          # ğŸ“Š Financer Dependency Dashboard
          
          **Last Updated:** $(date)
          **Status:** ${{ needs.check-dependencies.result == 'success' && needs.security-check.result == 'success' && needs.license-check.result == 'success' && 'âœ… All Good' || 'âš ï¸ Issues Found' }}
          
          ## ğŸ“¦ Dependency Status
          
          | Check | Status | Details |
          |-------|--------|---------|
          | Updates Available | ${{ needs.check-dependencies.outputs.updates-available == 'true' && 'â¬†ï¸ Yes' || 'âœ… Up to Date' }} | ${{ needs.check-dependencies.outputs.updates-available == 'true' && 'Updates available' || 'All dependencies current' }} |
          | Security | ${{ needs.security-check.result == 'success' && 'âœ… Clean' || 'âš ï¸ Issues' }} | OWASP dependency check |
          | Licenses | ${{ needs.license-check.result == 'success' && 'âœ… Compliant' || 'âš ï¸ Issues' }} | License compliance verified |
          
          ## ğŸ”§ Maven Modules Status
          
          | Module | Location | Status |
          |--------|----------|---------|
          | Parent POM | / | âœ… Active |
          | Common Library | shared/common-lib | âœ… Active |
          | Eureka Integration | shared/eureka-integration | âœ… Active |
          | Config Server | microservices/config-server | âœ… Active |
          | Eureka Server | microservices/eureka-server | âœ… Active |
          | API Gateway | microservices/api-gateway | âœ… Active |
          | Account Service | microservices/account-service | âœ… Active |
          
          ## ğŸ”’ Security Summary
          
          - **High Severity:** 0 vulnerabilities
          - **Medium Severity:** 0 vulnerabilities  
          - **Low Severity:** 0 vulnerabilities
          
          ## ğŸ“‹ Recommendations
          
          ${{ needs.check-dependencies.outputs.updates-available == 'true' && '- ğŸ“ˆ Consider updating available dependencies' || '- âœ… Dependencies are current' }}
          - ğŸ”’ Regular security scans are passing
          - âš–ï¸ License compliance is maintained
          - ğŸ§ª Automated testing continues to pass
          
          ## ğŸ”— Quick Links
          
          - [Dependency Updates Report](../../actions/artifacts)
          - [Security Report](../../actions/artifacts)
          - [License Report](../../actions/artifacts)
          
          ---
          *Dashboard generated automatically by GitHub Actions*
          EOF

      - name: Upload dashboard
        uses: actions/upload-artifact@v4
        with:
          name: dependency-dashboard
          path: dependency-dashboard.md

  # Job 6: Notification
  notify-results:
    runs-on: ubuntu-latest
    needs: [check-dependencies, security-check, license-check, create-update-pr]
    if: always()
    
    steps:
      - name: Notify on Security Issues
        if: needs.security-check.result == 'failure'
        run: |
          echo "ğŸš¨ SECURITY ALERT: Vulnerabilities detected in dependencies!"
          echo "Please review the security report and update vulnerable dependencies."
          # Add notification logic here
          
      - name: Notify on License Issues
        if: needs.license-check.result == 'failure'
        run: |
          echo "âš–ï¸ LICENSE ALERT: License compliance issues detected!"
          echo "Please review the license report and resolve compliance issues."
          # Add notification logic here
          
      - name: Notify on Updates
        if: needs.check-dependencies.outputs.updates-available == 'true'
        run: |
          echo "ğŸ“¦ DEPENDENCY UPDATES: New versions available!"
          echo "Automated PR has been created for safe updates."
          # Add notification logic here