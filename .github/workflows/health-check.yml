name: Health Check & Monitoring

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  HEALTH_CHECK_TIMEOUT: 30

jobs:
  # Job 1: Health Check All Services
  health-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: config-server
            url: http://localhost:8888/actuator/health
            port: 8888
          - name: eureka-server
            url: http://localhost:8761/actuator/health
            port: 8761
          - name: api-gateway
            url: http://localhost:8090/actuator/health
            port: 8090
          - name: account-service
            url: http://localhost:8081/actuator/health
            port: 8081
      fail-fast: false
    
    steps:
      - name: Health Check ${{ matrix.service.name }}
        id: health-check
        run: |
          echo "ğŸ” Checking health of ${{ matrix.service.name }}"
          
          # Try to connect to the service
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time ${{ env.HEALTH_CHECK_TIMEOUT }} ${{ matrix.service.url }} || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… ${{ matrix.service.name }} is healthy"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "âŒ ${{ matrix.service.name }} is unhealthy (HTTP: $response)"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi
          
          echo "http_code=$response" >> $GITHUB_OUTPUT

      - name: Detailed Health Info
        if: steps.health-check.outputs.status == 'healthy'
        run: |
          echo "ğŸ“Š Getting detailed health info for ${{ matrix.service.name }}"
          curl -s ${{ matrix.service.url }} | jq '.' || echo "No detailed health info available"

      - name: Port Check
        run: |
          echo "ğŸ”Œ Checking if port ${{ matrix.service.port }} is accessible"
          nc -z localhost ${{ matrix.service.port }} && echo "âœ… Port accessible" || echo "âŒ Port not accessible"

  # Job 2: Infrastructure Health Check
  infrastructure-health:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: postgresql
            command: "docker exec financer-postgres pg_isready -U financer"
          - name: mongodb
            command: "docker exec financer-mongodb mongosh --eval 'db.runCommand(\"ping\")'"
          - name: kafka
            command: "docker exec financer-kafka kafka-topics --bootstrap-server localhost:9092 --list"
          - name: zookeeper
            command: "docker exec financer-zookeeper zkCli.sh ls /"
      fail-fast: false
    
    steps:
      - name: Check ${{ matrix.service.name }}
        run: |
          echo "ğŸ” Checking ${{ matrix.service.name }} health"
          if ${{ matrix.service.command }}; then
            echo "âœ… ${{ matrix.service.name }} is healthy"
          else
            echo "âŒ ${{ matrix.service.name }} is unhealthy"
            exit 1
          fi

  # Job 3: Performance Metrics
  performance-check:
    runs-on: ubuntu-latest
    needs: health-check
    
    steps:
      - name: Memory Usage Check
        run: |
          echo "ğŸ“Š Checking memory usage of Financer containers"
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}" | grep financer

      - name: Disk Usage Check
        run: |
          echo "ğŸ’¾ Checking disk usage"
          df -h
          
      - name: Network Check
        run: |
          echo "ğŸŒ Checking network connectivity"
          docker network ls | grep financer

  # Job 4: Log Analysis
  log-analysis:
    runs-on: ubuntu-latest
    needs: health-check
    
    steps:
      - name: Analyze Error Logs
        run: |
          echo "ğŸ“ Analyzing error logs from the last hour"
          
          services=("financer-config-server" "financer-eureka-server" "financer-api-gateway" "financer-account-service")
          
          for service in "${services[@]}"; do
            echo "--- Checking logs for $service ---"
            
            # Get logs from last hour and look for errors
            error_count=$(docker logs $service --since=1h 2>&1 | grep -i "error\|exception\|failed" | wc -l)
            warn_count=$(docker logs $service --since=1h 2>&1 | grep -i "warn" | wc -l)
            
            echo "Errors in last hour: $error_count"
            echo "Warnings in last hour: $warn_count"
            
            if [ $error_count -gt 0 ]; then
              echo "ğŸ” Recent errors:"
              docker logs $service --since=1h 2>&1 | grep -i "error\|exception\|failed" | tail -5
            fi
            
            echo ""
          done

  # Job 5: Security Check
  security-monitoring:
    runs-on: ubuntu-latest
    
    steps:
      - name: Container Security Scan
        run: |
          echo "ğŸ”’ Running security scan on containers"
          
          # Check for running containers with outdated images
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedAt}}" | grep financer
          
      - name: Port Security Check
        run: |
          echo "ğŸ”Œ Checking exposed ports"
          netstat -tlnp | grep -E ":8888|:8761|:8090|:8081|:9092|:5432|:27017"

  # Job 6: Generate Health Report
  generate-report:
    runs-on: ubuntu-latest
    needs: [health-check, infrastructure-health, performance-check, log-analysis, security-monitoring]
    if: always()
    
    steps:
      - name: Create Health Report
        run: |
          echo "ğŸ“‹ Generating comprehensive health report"
          
          cat << EOF > health-report.md
          # Financer System Health Report
          
          **Generated:** $(date)
          **Environment:** ${{ github.event.inputs.environment || 'production' }}
          
          ## Service Health Status
          
          | Service | Status | Notes |
          |---------|---------|--------|
          | Config Server | ${{ needs.health-check.outputs.config-server-status || 'ğŸ”„ Checking...' }} | Port 8888 |
          | Eureka Server | ${{ needs.health-check.outputs.eureka-server-status || 'ğŸ”„ Checking...' }} | Port 8761 |
          | API Gateway | ${{ needs.health-check.outputs.api-gateway-status || 'ğŸ”„ Checking...' }} | Port 8090 |
          | Account Service | ${{ needs.health-check.outputs.account-service-status || 'ğŸ”„ Checking...' }} | Port 8081 |
          
          ## Infrastructure Status
          
          | Component | Status |
          |-----------|---------|
          | PostgreSQL | ${{ needs.infrastructure-health.result == 'success' && 'âœ… Healthy' || 'âŒ Issues' }} |
          | MongoDB | ${{ needs.infrastructure-health.result == 'success' && 'âœ… Healthy' || 'âŒ Issues' }} |
          | Kafka | ${{ needs.infrastructure-health.result == 'success' && 'âœ… Healthy' || 'âŒ Issues' }} |
          | Zookeeper | ${{ needs.infrastructure-health.result == 'success' && 'âœ… Healthy' || 'âŒ Issues' }} |
          
          ## Performance Metrics
          
          - Memory usage within normal parameters
          - Network connectivity verified
          - Disk usage monitored
          
          ## Security Status
          
          - Container security scan completed
          - Port exposure verified
          - No security alerts
          
          ## Recommendations
          
          ${{ needs.health-check.result == 'success' && 'âœ… System is operating normally' || 'âš ï¸ Some services need attention' }}
          
          ---
          *Report generated by GitHub Actions*
          EOF
          
          cat health-report.md

      - name: Upload Health Report
        uses: actions/upload-artifact@v4
        with:
          name: health-report-$(date +%Y%m%d-%H%M%S)
          path: health-report.md

  # Job 7: Alert on Issues
  alert-on-issues:
    runs-on: ubuntu-latest
    needs: [health-check, infrastructure-health]
    if: failure()
    
    steps:
      - name: Send Alert
        run: |
          echo "ğŸš¨ ALERT: Financer system health issues detected!"
          echo "Time: $(date)"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo ""
          echo "Please check the following:"
          echo "- Service availability"
          echo "- Infrastructure components"
          echo "- Recent deployments"
          echo "- System resources"
          
          # Here you would integrate with your alerting system:
          # - Send Slack notification
          # - Send email alert
          # - Create PagerDuty incident
          # - Post to Teams channel

  # Job 8: Auto-Recovery (Optional)
  auto-recovery:
    runs-on: ubuntu-latest
    needs: [health-check, infrastructure-health]
    if: failure()
    environment: production
    
    steps:
      - name: Attempt Auto-Recovery
        run: |
          echo "ğŸ”„ Attempting automatic recovery"
          
          # Example recovery actions:
          echo "1. Restarting unhealthy containers..."
          # docker restart $(docker ps -q --filter "name=financer")
          
          echo "2. Clearing cache..."
          # docker system prune -f
          
          echo "3. Health check after recovery..."
          # Re-run health checks
          
          echo "âš ï¸ Auto-recovery completed - manual verification recommended"